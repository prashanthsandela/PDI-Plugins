<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PageDownloadStepDialog.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">page-download</a> &gt; <a href="index.source.html" class="el_package">org.pentaho.di.sdk.plugin.steps.pagedownload</a> &gt; <span class="el_source">PageDownloadStepDialog.java</span></div><h1>PageDownloadStepDialog.java</h1><pre class="source lang-java linenums">/*! ******************************************************************************
*
* Pentaho Data Integration
*
* Copyright (C) 2002-2013 by Pentaho : http://www.pentaho.com
*
*******************************************************************************
*
* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
* you may not use this file except in compliance with
* the License. You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*
******************************************************************************/

package org.pentaho.di.sdk.plugin.steps.pagedownload;

import org.eclipse.swt.SWT;
import org.eclipse.swt.events.FocusListener;
import org.eclipse.swt.events.ModifyEvent;
import org.eclipse.swt.events.ModifyListener;
import org.eclipse.swt.events.SelectionAdapter;
import org.eclipse.swt.events.SelectionEvent;
import org.eclipse.swt.events.SelectionListener;
import org.eclipse.swt.events.ShellAdapter;
import org.eclipse.swt.events.ShellEvent;
import org.eclipse.swt.layout.FormAttachment;
import org.eclipse.swt.layout.FormData;
import org.eclipse.swt.layout.FormLayout;
import org.eclipse.swt.widgets.Button;
import org.eclipse.swt.widgets.Display;
import org.eclipse.swt.widgets.Event;
import org.eclipse.swt.widgets.Label;
import org.eclipse.swt.widgets.Listener;
import org.eclipse.swt.widgets.Shell;
import org.eclipse.swt.widgets.Text;
import org.pentaho.di.core.Const;
import org.pentaho.di.core.exception.KettleException;
import org.pentaho.di.core.row.RowMetaInterface;
import org.pentaho.di.i18n.BaseMessages;
import org.pentaho.di.trans.TransMeta;
import org.pentaho.di.ui.core.dialog.ErrorDialog;
import org.pentaho.di.ui.core.widget.LabelComboVar;
import org.pentaho.di.ui.trans.step.BaseStepDialog;
import org.pentaho.di.trans.step.BaseStepMeta;
import org.pentaho.di.trans.step.StepDialogInterface;

/**
 * This class is part of the demo step plug-in implementation.
 * It demonstrates the basics of developing a plug-in step for PDI. 
 * 
 * The demo step adds a new string field to the row stream and sets its
 * value to &quot;Hello World!&quot;. The user may select the name of the new field.
 *   
 * This class is the implementation of StepDialogInterface.
 * Classes implementing this interface need to:
 * 
 * - build and open a SWT dialog displaying the step's settings (stored in the step's meta object)
 * - write back any changes the user makes to the step's meta object
 * - report whether the user changed any settings when confirming the dialog 
 * 
 */
public class PageDownloadStepDialog extends BaseStepDialog implements StepDialogInterface {

	/**
	 *	The PKG member is used when looking up internationalized strings.
	 *	The properties file with localized keys is expected to reside in 
	 *	{the package of the class specified}/messages/messages_{locale}.properties   
	 */
<span class="nc" id="L77">	private static Class&lt;?&gt; PKG = PageDownloadStepMeta.class; // for i18n purposes</span>

	// this is the object the stores the step's settings
	// the dialog reads the settings from it when opening
	// the dialog writes the settings to it when confirmed 
	private PageDownloadStepMeta meta;

	// text field holding the name of the field to add to the row stream
	private Text outputFieldName;
	
	private Text urlFieldName;
	
	private Button bUrlInputField;
	
	private String[] fieldNames;

	/**
	 * The constructor should simply invoke super() and save the incoming meta
	 * object to a local variable, so it can conveniently read and write settings
	 * from/to it.
	 * 
	 * @param parent 	the SWT shell to open the dialog in
	 * @param in		the meta object holding the step's settings
	 * @param transMeta	transformation description
	 * @param sname		the step name
	 */
	public PageDownloadStepDialog(Shell parent, Object in, TransMeta transMeta, String sname) {
<span class="nc" id="L104">		super(parent, (BaseStepMeta) in, transMeta, sname);</span>
<span class="nc" id="L105">		meta = (PageDownloadStepMeta) in;</span>
<span class="nc" id="L106">	}</span>

	/**
	 * This method is called by Spoon when the user opens the settings dialog of the step.
	 * It should open the dialog and return only once the dialog has been closed by the user.
	 * 
	 * If the user confirms the dialog, the meta object (passed in the constructor) must
	 * be updated to reflect the new step settings. The changed flag of the meta object must 
	 * reflect whether the step configuration was changed by the dialog.
	 * 
	 * If the user cancels the dialog, the meta object must not be updated, and its changed flag
	 * must remain unaltered.
	 * 
	 * The open() method must return the name of the step after the user has confirmed the dialog,
	 * or null if the user cancelled the dialog.
	 */
	public String open() {

		// store some convenient SWT variables 
<span class="nc" id="L125">		Shell parent = getParent();</span>
<span class="nc" id="L126">		Display display = parent.getDisplay();</span>

		// SWT code for preparing the dialog
<span class="nc" id="L129">		shell = new Shell(parent, SWT.DIALOG_TRIM | SWT.RESIZE | SWT.MIN | SWT.MAX);</span>
<span class="nc" id="L130">		props.setLook(shell);</span>
<span class="nc" id="L131">		setShellImage(shell, meta);</span>
		
		// Save the value of the changed flag on the meta object. If the user cancels
		// the dialog, it will be restored to this saved value.
		// The &quot;changed&quot; variable is inherited from BaseStepDialog
<span class="nc" id="L136">		changed = meta.hasChanged();</span>
		
		// The ModifyListener used on all controls. It will update the meta object to 
		// indicate that changes are being made.
<span class="nc" id="L140">		ModifyListener lsMod = new ModifyListener() {</span>
			public void modifyText(ModifyEvent e) {
<span class="nc" id="L142">				meta.setChanged();</span>
<span class="nc" id="L143">			}</span>
		};
		
		// ------------------------------------------------------- //
		// SWT code for building the actual settings dialog        //
		// ------------------------------------------------------- //
<span class="nc" id="L149">		FormLayout formLayout = new FormLayout();</span>
<span class="nc" id="L150">		formLayout.marginWidth = Const.FORM_MARGIN;</span>
<span class="nc" id="L151">		formLayout.marginHeight = Const.FORM_MARGIN;</span>

<span class="nc" id="L153">		shell.setLayout(formLayout);</span>
<span class="nc" id="L154">		shell.setText(BaseMessages.getString(PKG, &quot;PageDownload.Shell.Title&quot;)); </span>

<span class="nc" id="L156">		int middle = props.getMiddlePct();</span>
<span class="nc" id="L157">		int margin = Const.MARGIN;</span>

		// Stepname line
<span class="nc" id="L160">		wlStepname = new Label(shell, SWT.RIGHT);</span>
<span class="nc" id="L161">		wlStepname.setText(BaseMessages.getString(PKG, &quot;System.Label.StepName&quot;)); </span>
<span class="nc" id="L162">		props.setLook(wlStepname);</span>
<span class="nc" id="L163">		fdlStepname = new FormData();</span>
<span class="nc" id="L164">		fdlStepname.left = new FormAttachment(0, 0);</span>
<span class="nc" id="L165">		fdlStepname.right = new FormAttachment(middle, -margin);</span>
<span class="nc" id="L166">		fdlStepname.top = new FormAttachment(0, margin);</span>
<span class="nc" id="L167">		wlStepname.setLayoutData(fdlStepname);</span>
		
<span class="nc" id="L169">		wStepname = new Text(shell, SWT.SINGLE | SWT.LEFT | SWT.BORDER);</span>
<span class="nc" id="L170">		wStepname.setText(stepname);</span>
<span class="nc" id="L171">		props.setLook(wStepname);</span>
<span class="nc" id="L172">		wStepname.addModifyListener(lsMod);</span>
<span class="nc" id="L173">		fdStepname = new FormData();</span>
<span class="nc" id="L174">		fdStepname.left = new FormAttachment(middle, 0);</span>
<span class="nc" id="L175">		fdStepname.top = new FormAttachment(0, margin);</span>
<span class="nc" id="L176">		fdStepname.right = new FormAttachment(100, 0);</span>
<span class="nc" id="L177">		wStepname.setLayoutData(fdStepname);</span>

		// output field value
<span class="nc" id="L180">		Label wlValName = new Label(shell, SWT.RIGHT);</span>
<span class="nc" id="L181">		wlValName.setText(BaseMessages.getString(PKG, &quot;PageDownload.FieldName.Label&quot;)); </span>
<span class="nc" id="L182">		props.setLook(wlValName);</span>
<span class="nc" id="L183">		FormData fdlValName = new FormData();</span>
<span class="nc" id="L184">		fdlValName.left = new FormAttachment(0, 0);</span>
<span class="nc" id="L185">		fdlValName.right = new FormAttachment(middle, -margin);</span>
<span class="nc" id="L186">		fdlValName.top = new FormAttachment(wStepname, margin);</span>
<span class="nc" id="L187">		wlValName.setLayoutData(fdlValName);</span>

<span class="nc" id="L189">		outputFieldName = new Text(shell, SWT.SINGLE | SWT.LEFT | SWT.BORDER);</span>
<span class="nc" id="L190">		props.setLook(outputFieldName);</span>
<span class="nc" id="L191">		outputFieldName.addModifyListener(lsMod);</span>
<span class="nc" id="L192">		FormData fdValName = new FormData();</span>
<span class="nc" id="L193">		fdValName.left = new FormAttachment(middle, 0);</span>
<span class="nc" id="L194">		fdValName.right = new FormAttachment(100, 0);</span>
<span class="nc" id="L195">		fdValName.top = new FormAttachment(wStepname, margin);</span>
<span class="nc" id="L196">		outputFieldName.setLayoutData(fdValName);</span>
		
		// URL Field
<span class="nc" id="L199">		Label urlValName = new Label(shell, SWT.RIGHT);</span>
<span class="nc" id="L200">		urlValName.setText(BaseMessages.getString(PKG, &quot;PageDownload.urlField.Label&quot;)); </span>
<span class="nc" id="L201">		props.setLook(urlValName);</span>
<span class="nc" id="L202">		FormData urlFormDataValName = new FormData();</span>
<span class="nc" id="L203">		urlFormDataValName.left = new FormAttachment(0, 0);</span>
<span class="nc" id="L204">		urlFormDataValName.right = new FormAttachment(middle, -margin);</span>
<span class="nc" id="L205">		urlFormDataValName.top = new FormAttachment(outputFieldName, margin);</span>
<span class="nc" id="L206">		urlValName.setLayoutData(urlFormDataValName);</span>

<span class="nc" id="L208">		urlFieldName = new Text(shell, SWT.SINGLE | SWT.LEFT | SWT.BORDER);</span>
<span class="nc" id="L209">		props.setLook(urlFieldName);</span>
<span class="nc" id="L210">		urlFieldName.addModifyListener(lsMod);</span>
<span class="nc" id="L211">		FormData urlfdValName = new FormData();</span>
<span class="nc" id="L212">		urlfdValName.left = new FormAttachment(middle, 0);</span>
<span class="nc" id="L213">		urlfdValName.right = new FormAttachment(100, 0);</span>
<span class="nc" id="L214">		urlfdValName.top = new FormAttachment(outputFieldName, margin);</span>
<span class="nc" id="L215">		urlFieldName.setLayoutData(urlfdValName);</span>
		
		//Checkbox
<span class="nc" id="L218">		Label lUrlInputField = new Label(shell, SWT.RIGHT);</span>
<span class="nc" id="L219">		lUrlInputField.setText(BaseMessages.getString(PKG, &quot;PageDownloadStep.InputFields.Label&quot;)); </span>
<span class="nc" id="L220">		props.setLook(lUrlInputField);</span>
<span class="nc" id="L221">		FormData fdUrlInputField = new FormData();</span>
<span class="nc" id="L222">		urlFormDataValName.left = new FormAttachment(0, 0);</span>
<span class="nc" id="L223">		urlFormDataValName.right = new FormAttachment(middle, -margin);</span>
<span class="nc" id="L224">		urlFormDataValName.top = new FormAttachment(urlFieldName, margin);</span>
<span class="nc" id="L225">		lUrlInputField.setLayoutData(urlFormDataValName);</span>
		
<span class="nc" id="L227">		bUrlInputField = new Button(shell, SWT.CHECK | SWT.LEFT);</span>
<span class="nc" id="L228">		props.setLook(bUrlInputField);</span>
		//bUrlInputField.addSelectionListener(lsMod);
<span class="nc" id="L230">		FormData fdbUrlInputField = new FormData();</span>
<span class="nc" id="L231">		fdbUrlInputField.left = new FormAttachment(middle, 0);</span>
<span class="nc" id="L232">		fdbUrlInputField.right = new FormAttachment(100, 0);</span>
<span class="nc" id="L233">		fdbUrlInputField.top = new FormAttachment(urlFieldName, margin);</span>
<span class="nc" id="L234">		bUrlInputField.setLayoutData(fdbUrlInputField);</span>
		
		// Checkbox
//		Label prevStep = new Label(shell, SWT.RIGHT);
//		prevStep.setText(BaseMessages.getString(PKG, &quot;PageDownloadStep.PrevStep.Label&quot;));
//		
//		final Button prevCheckboxStep = new Button( shell, SWT.CHECK | SWT.RIGHT );
//		prevCheckboxStep.setToolTipText( BaseMessages.getString( PKG, &quot;PageDownloadStep.PrevStep.Tooltip&quot; ) );
//
//		final LabelComboVar selectInputField = new LabelComboVar( transMeta, shell,
//		        BaseMessages.getString( PKG, &quot;PageDownloadStep.InputFields.Label&quot; ),
//		        BaseMessages.getString( PKG, &quot;PageDownloadStep.InputFields.Tooltip&quot; ) );
//		selectInputField.getComboWidget().setEditable( true );
//		props.setLook( selectInputField );
//		selectInputField.addModifyListener( lsMod );
//		selectInputField.addFocusListener( new FocusListener() {
//		public void focusLost( org.eclipse.swt.events.FocusEvent e ) {}
//
//		public void focusGained( org.eclipse.swt.events.FocusEvent e ) {
//			getPreviousFields( selectInputField );
//		}
//		});
//	    getPreviousFields( selectInputField );
//	    selectInputField.setEnabled( prevCheckboxStep.getSelection() );
//		
//		prevCheckboxStep.addSelectionListener(new SelectionListener() {
//			
//			public void widgetSelected(SelectionEvent arg0) {
//				selectInputField.setEnabled(prevCheckboxStep.getSelection());
//			}
//			
//			public void widgetDefaultSelected(SelectionEvent arg0) {
//				widgetSelected(arg0);
//			}
//		});
		      
		// OK and cancel buttons
<span class="nc" id="L271">		wOK = new Button(shell, SWT.PUSH);</span>
<span class="nc" id="L272">		wOK.setText(BaseMessages.getString(PKG, &quot;System.Button.OK&quot;)); </span>
<span class="nc" id="L273">		wCancel = new Button(shell, SWT.PUSH);</span>
<span class="nc" id="L274">		wCancel.setText(BaseMessages.getString(PKG, &quot;System.Button.Cancel&quot;)); </span>

<span class="nc" id="L276">		BaseStepDialog.positionBottomButtons(shell, new Button[] { wOK, wCancel }, margin, bUrlInputField);</span>

		// Add listeners for cancel and OK
<span class="nc" id="L279">		lsCancel = new Listener() {</span>
<span class="nc" id="L280">			public void handleEvent(Event e) {cancel();}</span>
		};
<span class="nc" id="L282">		lsOK = new Listener() {</span>
<span class="nc" id="L283">			public void handleEvent(Event e) {ok();}</span>
		};

<span class="nc" id="L286">		wCancel.addListener(SWT.Selection, lsCancel);</span>
<span class="nc" id="L287">		wOK.addListener(SWT.Selection, lsOK);</span>

		// default listener (for hitting &quot;enter&quot;)
<span class="nc" id="L290">		lsDef = new SelectionAdapter() {</span>
<span class="nc" id="L291">			public void widgetDefaultSelected(SelectionEvent e) {ok();}</span>
		};
<span class="nc" id="L293">		wStepname.addSelectionListener(lsDef);</span>
<span class="nc" id="L294">		outputFieldName.addSelectionListener(lsDef);</span>
<span class="nc" id="L295">		urlFieldName.addSelectionListener(lsDef);</span>

		// Detect X or ALT-F4 or something that kills this window and cancel the dialog properly
<span class="nc" id="L298">		shell.addShellListener(new ShellAdapter() {</span>
<span class="nc" id="L299">			public void shellClosed(ShellEvent e) {cancel();}</span>
		});
		
		// Set/Restore the dialog size based on last position on screen
		// The setSize() method is inherited from BaseStepDialog
<span class="nc" id="L304">		setSize();</span>

		// populate the dialog with the values from the meta object
<span class="nc" id="L307">		populateDialog();</span>
		
		// restore the changed flag to original value, as the modify listeners fire during dialog population 
<span class="nc" id="L310">		meta.setChanged(changed);</span>

		// open dialog and enter event loop 
<span class="nc" id="L313">		shell.open();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">		while (!shell.isDisposed()) {</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">			if (!display.readAndDispatch())</span>
<span class="nc" id="L316">				display.sleep();</span>
		}

		// at this point the dialog has closed, so either ok() or cancel() have been executed
		// The &quot;stepname&quot; variable is inherited from BaseStepDialog
<span class="nc" id="L321">		return stepname;</span>
	}
	
	/**
	 * This helper method puts the step configuration stored in the meta object
	 * and puts it into the dialog controls.
	 */
	private void populateDialog() {
<span class="nc" id="L329">		wStepname.selectAll();</span>
<span class="nc" id="L330">		outputFieldName.setText(meta.getOutputField());	</span>
<span class="nc" id="L331">		urlFieldName.setText(meta.getUrlField());</span>
<span class="nc" id="L332">	}</span>

	private void getPreviousFields( LabelComboVar combo ) {
<span class="nc" id="L335">	    String value = combo.getText();</span>
<span class="nc" id="L336">	    combo.removeAll();</span>
<span class="nc" id="L337">	    combo.setItems( getInputFieldNames() );</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">	    if ( value != null ) {</span>
<span class="nc" id="L339">	      combo.setText( value );</span>
	    }
<span class="nc" id="L341">	  }</span>

	private String[] getInputFieldNames() {
<span class="nc bnc" id="L344" title="All 2 branches missed.">	    if ( this.fieldNames == null ) {</span>
	      try {
<span class="nc" id="L346">	        RowMetaInterface r = transMeta.getPrevStepFields( stepname );</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">	        if ( r != null ) {</span>
<span class="nc" id="L348">	          fieldNames = r.getFieldNames();</span>
	        }
<span class="nc" id="L350">	      } catch ( KettleException ke ) {</span>
<span class="nc" id="L351">	        new ErrorDialog( shell,</span>
<span class="nc" id="L352">	          BaseMessages.getString( PKG, &quot;PageDownloadStep.FailedToGetFields.DialogTitle&quot; ),</span>
<span class="nc" id="L353">	          BaseMessages.getString( PKG, &quot;PageDownloadStep.FailedToGetFields.DialogMessage&quot; ), ke );</span>
<span class="nc" id="L354">	        return new String[0];</span>
<span class="nc" id="L355">	      }</span>
	    }

<span class="nc" id="L358">	    return fieldNames;</span>
	  }
	
	/**
	 * Called when the user cancels the dialog.  
	 */
	private void cancel() {
		// The &quot;stepname&quot; variable will be the return value for the open() method. 
		// Setting to null to indicate that dialog was cancelled.
<span class="nc" id="L367">		stepname = null;</span>
		// Restoring original &quot;changed&quot; flag on the met aobject
<span class="nc" id="L369">		meta.setChanged(changed);</span>
		// close the SWT dialog window
<span class="nc" id="L371">		dispose();</span>
<span class="nc" id="L372">	}</span>
	
	/**
	 * Called when the user confirms the dialog
	 */
	private void ok() {
		// The &quot;stepname&quot; variable will be the return value for the open() method. 
		// Setting to step name from the dialog control
<span class="nc" id="L380">		stepname = wStepname.getText(); </span>
		// Setting the  settings to the meta object
<span class="nc" id="L382">		meta.setOutputField(outputFieldName.getText());</span>
		
<span class="nc" id="L384">		meta.setUrlField(urlFieldName.getText());</span>
		// close the SWT dialog window
<span class="nc" id="L386">		dispose();</span>
<span class="nc" id="L387">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>